<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblia con Referencias Strong</title>
    <link href="bootstrap.min.css" rel="stylesheet">
    <script src="bootstrap.bundle.min.js"></script>
    <style>
        .word {
            cursor: pointer;
            color: blue;
            text-decoration: underline;
        }
        .word:hover {
            color: darkblue;
            background-color: lightblue;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .definition {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .versiculo-hover {
            padding: 5px;
            border-radius: 3px;
        }
        .popover {
            --bs-popover-bg: #fff3cd;
            --bs-popover-border-color: #ffc107;
            --bs-popover-header-color: #856404;
            --bs-popover-body-color: #212529;
            font-size: 14px;
            max-width: 300px;
        }
        .popover-header {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Biblia con Referencias Strong - Capítulos Completos</h1>
        <div class="row mb-4">
            <div class="col-md-3">
                <label for="testamento" class="form-label">Testamento</label>
                <select id="testamento" class="form-select">
                    <option value="AT">Antiguo Testamento</option>
                    <option value="NT">Nuevo Testamento</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="libro" class="form-label">Libro</label>
                <select id="libro" class="form-select">
                    <!-- Libros se cargarán dinámicamente -->
                </select>
            </div>
            <div class="col-md-3">
                <label for="capitulo" class="form-label">Capítulo</label>
                <select id="capitulo" class="form-select">
                    <!-- Capítulos se cargarán dinámicamente -->
                </select>
            </div>
            <div class="col-md-3">
                <label for="vista" class="form-label">Vista</label>
                <select id="vista" class="form-select">
                    <option value="todos">Todos</option>
                    <option value="hebreo">Solo Hebreo</option>
                    <option value="griego">Solo Griego</option>
                </select>
            </div>
            <!-- Removido selector de versículo -->
        </div>
        <div id="capitulo-header" class="mb-4 text-center"></div>
        <div class="d-flex justify-content-between mb-4">
            <button id="prev-capitulo" class="btn btn-secondary">Capítulo Anterior</button>
            <button id="next-capitulo" class="btn btn-secondary">Capítulo Siguiente</button>
        </div>
        <!-- Indicador de carga para diccionarios Strong -->
        <div id="main-content">
            <div class="row">
                <div class="col-md-6">
                    <h3>Reina Valera 1960</h3>
                    <div id="loading-rv" class="text-center mb-4" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p>Cargando capítulo...</p>
                    </div>
                    <div id="texto-rv" class="mb-4"></div>
                </div>
                <div class="col-md-6">
                    <h3>Texto Strong</h3>
                    <div id="loading-strong" class="text-center mb-4" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p>Cargando capítulo...</p>
                    </div>
                    <div id="texto-strong" class="mb-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const librosAT = [
            'génesis', 'éxodo', 'levítico', 'números', 'deuteronomio', 'josué', 'jueces', 'rut', '1 samuel', '2 samuel',
            '1 reyes', '2 reyes', '1 crónicas', '2 crónicas', 'esdras', 'nehemías', 'ester', 'job', 'salmos', 'proverbios',
            'eclesiastés', 'cantares', 'isaías', 'jeremías', 'lamentaciones', 'ezequiel', 'daniel', 'oseas', 'joel', 'amós',
            'abdías', 'jonás', 'miqueas', 'nahúm', 'habacuc', 'sofonías', 'hageo', 'zacarías', 'malaquías'
        ];

        const librosNT = [
            'mateo', 'marcos', 'lucas', 'juan', 'hechos', 'romanos', '1 corintios', '2 corintios', 'gálatas', 'efesios',
            'filipenses', 'colosenses', '1 tesalonicenses', '2 tesalonicenses', '1 timoteo', '2 timoteo', 'tito', 'filemón',
            'hebreos', 'santiago', '1 pedro', '2 pedro', '1 juan', '2 juan', '3 juan', 'judas', 'apocalipsis'
        ];

        let strongDataHebreo = {};
        let strongDataGriego = {};
        let currentTestament = 'AT';

        function updateVistaOptions() {
            const vistaSelect = document.getElementById('vista');
            vistaSelect.innerHTML = '';
            const optionTodos = document.createElement('option');
            optionTodos.value = 'todos';
            optionTodos.textContent = 'Todos';
            vistaSelect.appendChild(optionTodos);
            if (currentTestament === 'AT') {
                const optionHebreo = document.createElement('option');
                optionHebreo.value = 'hebreo';
                optionHebreo.textContent = 'Hebreo';
                vistaSelect.appendChild(optionHebreo);
            } else {
                const optionGriego = document.createElement('option');
                optionGriego.value = 'griego';
                optionGriego.textContent = 'Griego';
                vistaSelect.appendChild(optionGriego);
            }
        }

        updateVistaOptions();

        // Función para cargar un diccionario Strong específico bajo demanda
        async function loadStrongWord(code) {
            console.log('Cargando Strong:', code);
            
            // Determinar si es hebreo (H) o griego (G)
            const isHebrew = code.startsWith('H');
            const isGreek = code.startsWith('G');
            const prefix = isHebrew ? 'H' : 'G';
            const basePath = isHebrew ? 'strong_hebreo' : 'strong_griego';
            const dict = isHebrew ? strongDataHebreo : strongDataGriego;
            
            console.log('Es hebreo:', isHebrew, 'Es griego:', isGreek, 'Prefix:', prefix);
            
            // Si ya está cargado, retornar inmediatamente
            if (dict[code]) {
                console.log('Palabra ya cargada:', dict[code]);
                return dict[code];
            }
            
            try {
                // Extraer el número del código Strong
                const numberStr = isHebrew || isGreek ? code.substring(1) : code;
                const number = parseInt(numberStr);
                console.log('Número extraído:', number);
                
                // Calcular el archivo que contiene este código (agrupando por 10)
                const fileNumber = Math.ceil(number / 10);
                const fileName = `strong_${isHebrew ? 'hebrew' : 'greek'}_pagina_${fileNumber}.json`;
                console.log('Buscando archivo:', fileName);
                
                // Cargar el archivo
                const response = await fetch(`${basePath}/${fileName}`);
                if (!response.ok) {
                    console.error(`No se pudo cargar el archivo ${fileName}, status:`, response.status);
                    return null;
                }
                
                const data = await response.json();
                console.log(`Archivo cargado con ${data.length} palabras`);
                
                // Almacenar todas las palabras del archivo cargado CON prefijo
                data.forEach(item => {
                    const key = prefix + item.cod;
                    dict[key] = item;
                });
                
                // Retornar la palabra solicitada
                const result = dict[code];
                console.log('Resultado:', result ? 'Encontrado' : 'No encontrado', 'para código:', code);
                console.log('Diccionario tiene:', Object.keys(dict).length, 'entradas');
                return result || null;
            } catch (error) {
                console.error('Error cargando palabra Strong:', error);
                return null;
            }
        }

        function populateLibros() {
            const testamento = document.getElementById('testamento').value;
            const libroSelect = document.getElementById('libro');
            libroSelect.innerHTML = '';
            const libros = testamento === 'AT' ? librosAT : librosNT;
            libros.forEach(libro => {
                const option = document.createElement('option');
                option.value = libro;
                option.textContent = libro.charAt(0).toUpperCase() + libro.slice(1);
                libroSelect.appendChild(option);
            });
            populateCapitulos();
            updateVistaOptions();
        }

        function populateCapitulos() {
            // Para simplificar, asumir capítulos 1-50, pero en realidad cargar dinámicamente
            const capituloSelect = document.getElementById('capitulo');
            capituloSelect.innerHTML = '';
            for (let i = 1; i <= 50; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                capituloSelect.appendChild(option);
            }
            populateVersiculos();
        }

        function populateVersiculos() {
            // No necesitamos selector de versículo, cargamos el capítulo completo
            loadCapitulo();
        }

        function getFilePrefix(libro, testamento) {
            // Mapa de prefijos para nombres de archivo (sin caracteres especiales)
            const prefixMap = {
                // Antiguo Testamento
                '1 samuel': '1ra',
                '2 samuel': '2da',
                '1 reyes': '1ra',
                '2 reyes': '2da',
                '1 crónicas': '1ra',
                '2 crónicas': '2da',
                'levítico': 'levíticos',
                'números': 'números',
                'josué': 'josué',
                'jueces': 'jueces',
                'rut': 'rut',
                'esdras': 'esdras',
                'nehemías': 'nehemías',
                'eclesiastés': 'eclesiastés',
                'cantares': 'cantares',
                'isaías': 'isaías',
                'jeremías': 'jeremías',
                'ezequiel': 'ezequiel',
                'daniel': 'daniel',
                'oseas': 'oseas',
                'joel': 'joel',
                'amós': 'amós',
                'abdías': 'abdías',
                'jonás': 'jonás',
                'miqueas': 'miqueas',
                'nahúm': 'nahúm',
                'habacuc': 'habacuc',
                'sofonías': 'sofonías',
                'hageo': 'hageo',
                'zacarías': 'zacarías',
                'malaquías': 'malaquías',
                'génesis': 'génesis',
                'éxodo': 'éxodo',
                'lamentaciones': 'lamentaciones',
                'ester': 'ester',
                'job': 'job',
                'proverbios': 'proverbios',
                'salmos': 'salmos',
                
                // Nuevo Testamento
                '1 corintios': '1ra corintios',
                '2 corintios': '2da corintios',
                '1 tesalonicenses': '1ra tesalonicenses',
                '2 tesalonicenses': '2da tesalonicenses',
                '1 timoteo': '1ra timoteo',
                '2 timoteo': '2da timoteo',
                '1 pedro': '1ra pedro',
                '2 pedro': '2da pedro',
                '1 juan': '1ra juan',
                '2 juan': '2da juan',
                '3 juan': '3ra juan',
                'filemón': 'filemón',
                'mateo': 'mateo',
                'marcos': 'marcos',
                'lucas': 'lucas',
                'juan': 'juan',
                'hechos': 'hechos',
                'romanos': 'romanos',
                'gálatas': 'galatas',
                'efesios': 'efesios',
                'filipenses': 'filipenses',
                'colosenses': 'colosenses',
                'tito': 'tito',
                'hebreos': 'hebreos',
                'santiago': 'santiago',
                'judas': 'judas',
                'apocalipsis': 'apocalipsis'
            };
            
            // Retornar el prefijo del archivo (sin modificar el nombre del libro para la ruta)
            return prefixMap[libro.toLowerCase()] || libro;
        }

        // Función para normalizar nombres de libros según la estructura de carpetas
        function getLibroPath(libro) {
            // Mapa de nombres de libros a nombres de carpetas
            const libroToFolderMap = {
                // Antiguo Testamento
                'génesis': 'génesis',
                'éxodo': 'éxodo',
                'levítico': 'levítico',
                'números': 'números',
                'deuteronomio': 'deuteronomio',
                'josué': 'josué',
                'jueces': 'jueces',
                'rut': 'rut',
                '1 samuel': '1 samuel',
                '2 samuel': '2 samuel',
                '1 reyes': '1 reyes',
                '2 reyes': '2 reyes',
                '1 crónicas': '1 crónicas',
                '2 crónicas': '2 crónicas',
                'esdras': 'esdras',
                'nehemías': 'nehemías',
                'ester': 'ester',
                'job': 'job',
                'salmos': 'salmos',
                'proverbios': 'proverbios',
                'eclesiastés': 'eclesiastés',
                'cantares': 'cantares',
                'isaías': 'isaías',
                'jeremías': 'jeremías',
                'lamentaciones': 'lamentaciones',
                'ezequiel': 'ezequiel',
                'daniel': 'daniel',
                'oseas': 'oseas',
                'joel': 'joel',
                'amós': 'amós',
                'abdías': 'abdías',
                'jonás': 'jonás',
                'miqueas': 'miqueas',
                'nahúm': 'nahúm',
                'habacuc': 'habacuc',
                'sofonías': 'sofonías',
                'hageo': 'hageo',
                'zacarías': 'zacarías',
                'malaquías': 'malaquías',
                
                // Nuevo Testamento (nombres de archivo sin tildes)
                'mateo': 'mateo',
                'marcos': 'marcos',
                'lucas': 'lucas',
                'juan': 'juan',
                'hechos': 'hechos',
                'romanos': 'romanos',
                '1 corintios': '1 corintios',
                '2 corintios': '2 corintios',
                'gálatas': 'galatas',  // Sin tilde en el nombre del archivo
                'efesios': 'efesios',
                'filipenses': 'filipenses',
                'colosenses': 'colosenses',
                '1 tesalonicenses': '1 tesalonicenses',
                '2 tesalonicenses': '2 tesalonicenses',
                '1 timoteo': '1 timoteo',
                '2 timoteo': '2 timoteo',
                'tito': 'tito',
                'filemón': 'filemón',
                'hebreos': 'hebreos',
                'santiago': 'santiago',
                '1 pedro': '1 pedro',
                '2 pedro': '2 pedro',
                '1 juan': '1 juan',
                '2 juan': '2 juan',
                '3 juan': '3 juan',
                'judas': 'judas',
                'apocalipsis': 'apocalipsis'
            };
            
            // Si el libro está en el mapa, devolver el nombre de la carpeta correspondiente
            // De lo contrario, usar el nombre del libro en minúsculas
            const libroLower = libro.toLowerCase();
            return libroToFolderMap[libroLower] || libroLower;
        }

        async function loadCapitulo() {
            // Mostrar indicadores de carga
            document.getElementById('loading-rv').style.display = 'block';
            document.getElementById('loading-strong').style.display = 'block';
            document.getElementById('texto-rv').innerHTML = '';
            document.getElementById('texto-strong').innerHTML = '';

            const testamento = document.getElementById('testamento').value;
            currentTestament = testamento;
            let libro = document.getElementById('libro').value;
            const capitulo = document.getElementById('capitulo').value;
            const prefix = getFilePrefix(libro, testamento);
            
            // Obtener el nombre correcto de la carpeta para el libro
            const libroFolder = getLibroPath(libro);
            
            // Codificar solo la parte del libro en la URL
            const libroPath = encodeURIComponent(libroFolder);
            
            console.log('Cargando capítulo:', { 
                testamento, 
                libro, 
                libroFolder,
                capitulo, 
                prefix,
                libroPath
            });

            const versiculos = [];
            let versiculo = 1;
            let errorCount = 0;
            const maxErrors = 3; // Número máximo de errores consecutivos permitidos

            while (errorCount < maxErrors) {
                // Construir la ruta con el nombre de carpeta correcto
                // Usar el prefijo para el nombre del archivo (sin tildes) y libroPath para la carpeta (con tildes si es necesario)
                const fileName = `${prefix}_${capitulo}_${versiculo}.json`.toLowerCase();
                const path = `${testamento}/${libroPath}/${fileName}`;
                console.log('Intentando cargar:', path);
                
                try {
                    const response = await fetch(path);
                    if (!response.ok) {
                        console.log('Respuesta no OK para versículo', versiculo, ':', response.status);
                        errorCount++;
                        versiculo++;
                        continue;
                    }
                    const data = await response.json();
                    versiculos.push(data);
                    console.log('Versículo cargado:', versiculo);
                    versiculo++;
                    errorCount = 0; // Reiniciar contador de errores
                } catch (error) {
                    console.error('Error cargando versículo', versiculo, ':', error);
                    errorCount++;
                    versiculo++;
                }
            }
            displayCapitulo(versiculos);
            initPopovers();
        }

        function displayCapitulo(versiculos) {
            // Ocultar indicadores de carga
            document.getElementById('loading-rv').style.display = 'none';
            document.getElementById('loading-strong').style.display = 'none';

            if (versiculos.length === 0) {
                document.getElementById('capitulo-header').innerHTML = 'Capítulo no encontrado.';
                document.getElementById('texto-rv').innerHTML = '';
                document.getElementById('texto-strong').innerHTML = '';
                return;
            }

            // Extraer libro y capítulo de la primera referencia
            const referencia = versiculos[0].versiculo.referencia;
            const match = referencia.match(/^(.+?) (\d+):(\d+) (.+)$/);
            if (match) {
                const libro = match[1];
                const capitulo = match[2];
                const version = match[4];
                document.getElementById('capitulo-header').innerHTML = `<h2>${libro} ${capitulo} ${version}</h2>`;
            }

            const textoRvDiv = document.getElementById('texto-rv');
            const textoStrongDiv = document.getElementById('texto-strong');
            textoRvDiv.innerHTML = '';
            textoStrongDiv.innerHTML = '';

            versiculos.forEach((data, index) => {
                const versiculoNum = index + 1;
                const versiculoId = `versiculo-${versiculoNum}`;

                // Columna RV
                const rvDiv = document.createElement('div');
                rvDiv.id = `${versiculoId}-rv`;
                rvDiv.className = 'versiculo-hover';
                rvDiv.innerHTML = `<p><sup>${versiculoNum}</sup> ${data.versiculo.texto}</p>`;
                textoRvDiv.appendChild(rvDiv);

                // Columna Strong
                const strongDiv = document.createElement('div');
                strongDiv.id = `${versiculoId}-strong`;
                strongDiv.className = 'versiculo-hover';
                const idiomaEsperado = currentTestament === 'AT' ? 'hebreo' : 'griego';
                const prefix = currentTestament === 'AT' ? 'H' : 'G';
                const words = data.analisisInterlineal.map(item => {
                    const original = currentTestament === 'AT' ? item.hebreo : item.texto;
                    let strongNumber = item.strongNumber || item.strong;
                    
                    // Solo mostrar popover si hay un código Strong válido
                    if (!strongNumber) {
                        return `<span>${item.traduccion}</span>`;
                    }
                    
                    // Agregar prefijo H o G según el testamento si no lo tiene
                    if (!isNaN(strongNumber)) {
                        strongNumber = prefix + strongNumber;
                    }
                    
                    return `<span class="word" data-bs-toggle="popover" data-bs-placement="top" data-strong="${strongNumber}" data-idioma="${idiomaEsperado}" data-traduccion="${item.traduccion}" data-original="${original}">${item.traduccion}</span>`;
                }).join(' ');
                strongDiv.innerHTML = `<p><sup>${versiculoNum}</sup> ${words}</p>`;
                textoStrongDiv.appendChild(strongDiv);
            });
        }

        // Función para inicializar popovers
        function initPopovers() {
            const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
            [...popoverTriggerList].forEach(popoverTriggerEl => {
                // Evitar inicializar múltiples veces
                if (popoverTriggerEl.dataset.popoverInitialized === 'true') return;
                popoverTriggerEl.dataset.popoverInitialized = 'true';
                
                const strongNumber = popoverTriggerEl.dataset.strong;
                console.log('Inicializando popover para:', strongNumber);
                const idioma = popoverTriggerEl.dataset.idioma;
                const palabraOrig = popoverTriggerEl.dataset.original;
                const title = idioma === 'hebreo' ? `<span style="direction: rtl; display: inline-block;">${palabraOrig}</span>` : palabraOrig;
                
                // Contenido inicial con spinner de carga
                const loadingContent = `
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <span>Cargando definición...</span>
                    </div>
                `;
                
                const popover = new bootstrap.Popover(popoverTriggerEl, {
                    title: title,
                    html: true,
                    placement: 'top',
                    trigger: 'click',
                    content: loadingContent
                });
                
                // Cargar la definición SOLO cuando se muestra este popover específico
                popoverTriggerEl.addEventListener('shown.bs.popover', async function() {
                    // Evitar cargas múltiples simultáneas
                    if (popoverTriggerEl.dataset.loading === 'true') return;
                    
                    // Si ya se cargó la definición, no hacer nada
                    if (popoverTriggerEl.dataset.loaded === 'true') return;
                    
                    popoverTriggerEl.dataset.loading = 'true';
                    
                    try {
                        const strongData = await loadStrongWord(strongNumber);
                        let content;
                        if (strongData) {
                            content = `<strong>${strongData.palabra_original || palabraOrig}</strong> (${strongData.transliteracion || strongData.pron || ''})<br>${strongData.definicion || 'No disponible'}`;
                        } else {
                            content = '<span class="text-danger">Definición no encontrada.</span>';
                        }
                        
                        // Actualizar el contenido del popover específico de este elemento
                        const popoverInstance = bootstrap.Popover.getInstance(popoverTriggerEl);
                        if (popoverInstance && popoverInstance.tip) {
                            const popoverBody = popoverInstance.tip.querySelector('.popover-body');
                            if (popoverBody) {
                                popoverBody.innerHTML = content;
                            }
                        }
                        
                        // Marcar como cargado
                        popoverTriggerEl.dataset.loaded = 'true';
                    } catch (error) {
                        console.error('Error al cargar definición:', error);
                        const popoverInstance = bootstrap.Popover.getInstance(popoverTriggerEl);
                        if (popoverInstance && popoverInstance.tip) {
                            const popoverBody = popoverInstance.tip.querySelector('.popover-body');
                            if (popoverBody) {
                                popoverBody.innerHTML = '<span class="text-danger">Error al cargar la definición.</span>';
                            }
                        }
                    } finally {
                        popoverTriggerEl.dataset.loading = 'false';
                    }
                });
            });
        }

        async function updateWords(vista) {
            const words = document.querySelectorAll('.word');
            for (const word of words) {
                const code = word.getAttribute('data-strong');
                if (!code) continue;
                
                const isHebrew = code.startsWith('H');
                
                // Mostrar/ocultar según la vista seleccionada
                if (vista !== 'todos' && 
                    ((vista === 'hebreo' && !isHebrew) || 
                     (vista === 'griego' && isHebrew))) {
                    word.style.display = 'none';
                    continue;
                }
                
                word.style.display = 'inline';
            }
        }

        document.addEventListener('mouseover', function(e) {
            if (e.target.closest('.versiculo-hover')) {
                const target = e.target.closest('.versiculo-hover');
                const id = target.id;
                const baseId = id.replace('-rv', '').replace('-strong', '');
                const rvDiv = document.getElementById(`${baseId}-rv`);
                const strongDiv = document.getElementById(`${baseId}-strong`);
                if (rvDiv) rvDiv.style.backgroundColor = '#e9ecef';
                if (strongDiv) strongDiv.style.backgroundColor = '#e9ecef';
            }
        });

        document.addEventListener('mouseout', function(e) {
            if (e.target.closest('.versiculo-hover')) {
                const target = e.target.closest('.versiculo-hover');
                const id = target.id;
                const baseId = id.replace('-rv', '').replace('-strong', '');
                const rvDiv = document.getElementById(`${baseId}-rv`);
                const strongDiv = document.getElementById(`${baseId}-strong`);
                
                if (rvDiv) rvDiv.classList.remove('bg-warning', 'bg-opacity-25');
                if (strongDiv) strongDiv.classList.remove('bg-warning', 'bg-opacity-25');
            }
        });

        document.getElementById('testamento').addEventListener('change', populateLibros);
        document.getElementById('libro').addEventListener('change', populateCapitulos);
        document.getElementById('capitulo').addEventListener('change', populateVersiculos);

        document.getElementById('vista').addEventListener('change', function() {
            const vista = this.value;
            updateWords(vista);
        });

        document.getElementById('prev-capitulo').addEventListener('click', async () => {
            const testamentoSelect = document.getElementById('testamento');
            const libroSelect = document.getElementById('libro');
            const capituloSelect = document.getElementById('capitulo');
            const testamento = testamentoSelect.value;
            const libro = libroSelect.value;
            const currentCap = parseInt(capituloSelect.value);
            if (currentCap > 1) {
                capituloSelect.value = currentCap - 1;
                populateVersiculos();
            } else {
                const libros = testamento === 'AT' ? librosAT : librosNT;
                const currentIndex = libros.indexOf(libro);
                if (currentIndex > 0) {
                    libroSelect.value = libros[currentIndex - 1];
                    populateCapitulos();
                    // Find the last chapter
                    for (let cap = 50; cap >= 1; cap--) {
                        const prevLibro = libros[currentIndex - 1];
                        const prevPrefix = getFilePrefix(prevLibro, testamento);
                        const path = `${testamento}/${prevLibro}/${prevPrefix}_${cap}_1.json`;
                        try {
                            const response = await fetch(path);
                            if (response.ok) {
                                capituloSelect.value = cap;
                                populateVersiculos();
                                break;
                            }
                        } catch (e) {}
                    }
                } else if (testamento === 'NT') {
                    testamentoSelect.value = 'AT';
                    populateLibros();
                    libroSelect.value = librosAT[librosAT.length - 1];
                    populateCapitulos();
                    // Find the last chapter of the last book in AT
                    for (let cap = 50; cap >= 1; cap--) {
                        const lastLibro = librosAT[librosAT.length - 1];
                        const lastPrefix = getFilePrefix(lastLibro, 'AT');
                        const path = `AT/${lastLibro}/${lastPrefix}_${cap}_1.json`;
                        try {
                            const response = await fetch(path);
                            if (response.ok) {
                                capituloSelect.value = cap;
                                populateVersiculos();
                                break;
                            }
                        } catch (e) {}
                    }
                }
            }
        });

        document.getElementById('next-capitulo').addEventListener('click', async () => {
            const testamentoSelect = document.getElementById('testamento');
            const libroSelect = document.getElementById('libro');
            const capituloSelect = document.getElementById('capitulo');
            const testamento = testamentoSelect.value;
            const libro = libroSelect.value;
            const currentCap = parseInt(capituloSelect.value);
            const nextCap = currentCap + 1;
            const prefix = getFilePrefix(libro, testamento);
            const path = `${testamento}/${libro}/${prefix}_${nextCap}_1.json`;
            try {
                const response = await fetch(path);
                if (response.ok) {
                    capituloSelect.value = nextCap;
                    populateVersiculos();
                } else {
                    throw new Error();
                }
            } catch (e) {
                // Change book
                const libros = testamento === 'AT' ? librosAT : librosNT;
                const currentIndex = libros.indexOf(libro);
                if (currentIndex < libros.length - 1) {
                    libroSelect.value = libros[currentIndex + 1];
                    populateCapitulos();
                    capituloSelect.value = 1;
                    populateVersiculos();
                } else if (testamento === 'AT') {
                    testamentoSelect.value = 'NT';
                    populateLibros();
                    libroSelect.value = librosNT[0];
                    populateCapitulos();
                    capituloSelect.value = 1;
                    populateVersiculos();
                }
                // If at the end of NT, do nothing
            }
        });

        // Inicializar
        populateLibros();

    </script>
</body>
</html>